AWSTemplateFormatVersion: '2010-09-09'
Description: The RASD service stack

Parameters:
  pEnvironment:
    Type: String
    Description: The AWS environment this belongs to

Conditions:
  IsDev: !Equals
    - !Ref pEnvironment
    - development
  NotDev: !Not
    - !Condition IsDev

Resources:
  DynamoDBTableDataAccessRequests:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    Properties:
      AttributeDefinitions:
        - AttributeType: S
          AttributeName: id
      BillingMode: PAY_PER_REQUEST
      KeySchema:
        - KeyType: HASH
          AttributeName: id

  DynamoDBTableMetadata:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    Properties:
      AttributeDefinitions:
        - AttributeType: S
          AttributeName: id
      BillingMode: PAY_PER_REQUEST
      KeySchema:
        - KeyType: HASH
          AttributeName: id

  DynamoDBTableOrganisations:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    Properties:
      AttributeDefinitions:
        - AttributeType: S
          AttributeName: id
      BillingMode: PAY_PER_REQUEST
      KeySchema:
        - KeyType: HASH
          AttributeName: id

  DynamoDBTableRegistrations:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    Properties:
      AttributeDefinitions:
        - AttributeType: S
          AttributeName: id
      BillingMode: PAY_PER_REQUEST
      KeySchema:
        - KeyType: HASH
          AttributeName: id

  CognitoPool:
    Type: AWS::Cognito::UserPool
    DeletionPolicy: Retain
    Properties:
      AccountRecoverySetting:
        RecoveryMechanisms:
          - Name: verified_email
            Priority: 1
      UsernameAttributes:
        - email
      UsernameConfiguration:
        CaseSensitive: false
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: true
          RequireUppercase: true
          TemporaryPasswordValidityDays: 3
      Schema:
        - AttributeDataType: String
          Mutable: true
          Name: organisation_id
        - AttributeDataType: String
          Mutable: true
          Name: family_name
          Required: true
          StringAttributeConstraints:
            MaxLength: '2048'
            MinLength: '0'
        - AttributeDataType: String
          Mutable: true
          Name: given_name
          Required: true
          StringAttributeConstraints:
            MaxLength: '2048'
            MinLength: '0'
        - AttributeDataType: String
          Mutable: true
          Name: email
          Required: true
          StringAttributeConstraints:
            MaxLength: '2048'
            MinLength: '0'

  CognitoGroupAdmin:
    Type: AWS::Cognito::UserPoolGroup
    DeletionPolicy: Retain
    Properties:
      Description: Used by the RASD backend to determine user permission level. RASD Admins (inside the app).
      GroupName: Administrators
      Precedence: 1
      UserPoolId: ap-southeast-2_8Vln95ht4

  CognitoGroupCustodians:
    Type: AWS::Cognito::UserPoolGroup
    DeletionPolicy: Retain
    Properties:
      Description: Used by the RASD backend to determine user permission level. RASD Custodians (inside the app).
      GroupName: DataCustodians
      Precedence: 2
      UserPoolId: ap-southeast-2_8Vln95ht4

  CognitoGroupRequestors:
    Type: AWS::Cognito::UserPoolGroup
    DeletionPolicy: Retain
    Properties:
      Description: Used by the RASD backend to determine user permission level. RASD Requestors (inside the app).
      GroupName: DataRequestors
      Precedence: 3
      UserPoolId: ap-southeast-2_8Vln95ht4

  CognitoAppClientRasdbackend:
    Type: AWS::Cognito::UserPoolClient
    DeletionPolicy: Retain
    Properties:
      UserPoolId: ap-southeast-2_8Vln95ht4
      PreventUserExistenceErrors: ENABLED
      GenerateSecret: True
      EnableTokenRevocation: True
      AccessTokenValidity: 180
      IdTokenValidity: 180
      RefreshTokenValidity: 30
      TokenValidityUnits:
        AccessToken: minutes
        IdToken: minutes
        RefreshToken: days
      ExplicitAuthFlows:
        - ALLOW_ADMIN_USER_PASSWORD_AUTH
        - ALLOW_CUSTOM_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_USER_SRP_AUTH
      ReadAttributes:
        - given_name
        - email_verified
        - custom:organisation_id
        - zoneinfo
        - website
        - preferred_username
        - name
        - locale
        - phone_number
        - family_name
        - birthdate
        - middle_name
        - phone_number_verified
        - profile
        - picture
        - address
        - gender
        - updated_at
        - nickname
        - email
      WriteAttributes:
        - given_name
        - custom:organisation_id
        - zoneinfo
        - website
        - preferred_username
        - name
        - locale
        - phone_number
        - family_name
        - birthdate
        - middle_name
        - profile
        - picture
        - address
        - gender
        - updated_at
        - nickname
        - email

  ApiGatewayCustomDomainName:
    Type: AWS::ApiGatewayV2::DomainName
    DeletionPolicy: Delete
    Properties:
      DomainName: service.migrating.testing.rasd.org.au
      DomainNameConfigurations:
        - EndpointType: REGIONAL
          SecurityPolicy: TLS_1_2
